/******************************************************Copyright (c)**************************************************
**                                              胆怯是阻止一切可能的根本缘由
**
**                                             E-Mail: ChinaFengliang@163.com
**
**---------File Information-------------------------------------------------------------------------------------------
** File name:            can0.c
** Last version:         V1.00
** Descriptions:         can0驱动文件.
** Hardware platform:    lpc1768
** SoftWare platform:    ChinaOS
**
**--------------------------------------------------------------------------------------------------------------------
** Created by:           Feng Liang
** Created date:         2011年12月13日  17:10:22
** Version:              V1.00
** Descriptions:         The original version
**
**--------------------------------------------------------------------------------------------------------------------
** Modified by: 
** Modified date:
** Version:
** Descriptions:
**
*********************************************************************************************************************/

/*********************************************************************************************************************
                                                    头文件区
*********************************************************************************************************************/
#include    <include/macro.h>
#include    <include/types.h>
#include    <library/ioport.h>
#include    <nvic/interrupt.h>
#include    "../../lpc17xx.h"
#include    "./can.h"

/*********************************************************************************************************************
                                                    宏定义区
*********************************************************************************************************************/
/* 宏段名 ----------------------------------------------------------------------------------------------------------*/


/*********************************************************************************************************************
                                                    类型定义区
*********************************************************************************************************************/
/* 基本类型 --------------------------------------------------------------------------------------------------------*/


/*********************************************************************************************************************
                                                  全局变量定义区
*********************************************************************************************************************/
CAN_FEATURE can0_feature =                                                  /* can0设备特性  (输入频率:25MHz)       */
{
    0x40044000,                                                             /* 寄存器基址                           */
    14,
    CAN_IRQn,
    NULL,

    NULL,
    NULL,

    1,
    5,
    2,
};

/*********************************************************************************************************************
** Function name:           can0_setup
** Descriptions:            安装can0设备
** Input parameters:        
** Output parameters:       
** Returned value:          ==OS_OK : 操作成功
**                          !=OS_OK : 操作失败(包含出错信息)
**--------------------------------------------------------------------------------------------------------------------
** Created by:              Feng Liang
** Created Date:            2011-12-13  17:13:54
** Test recorde:            
**--------------------------------------------------------------------------------------------------------------------
** Modified by:
** Modified date:
** Test recorde: 
*********************************************************************************************************************/
static int can0_setup(void)
{
    /* 1)
     * 私有构建过程
     */
    dword_set_bits(PCONP, 1ul << 13);                                       /* 使能can0外设备供电                   */
    dword_modify(PINSEL0, 0x0A, 0x05);                                      /* 设置P0.0功能:RD0;  P0.1功能:TD0      */

    /* 2)
     * 类构建过程
     */
    can_setup(&can0_feature);

    return OK;
}

/*********************************************************************************************************************
** Function name:           can0_send
** Descriptions:            发送消息报文
** Input parameters:        pMessage : 消息报文
**                          Timeout  : 超时时间(单位: 毫秒)
** Output parameters:       
** Returned value:          ==OS_OK : 操作成功
**                          !=OS_OK : 操作失败(包含出错信息)
**--------------------------------------------------------------------------------------------------------------------
** Created by:              Feng Liang
** Created Date:            2011-12-13  17:18:29
** Test recorde:            
**--------------------------------------------------------------------------------------------------------------------
** Modified by:
** Modified date:
** Test recorde: 
*********************************************************************************************************************/
static int can0_send(CAN_MESSAGE *pMessage, int Timeout)
{
    return can_send(&can0_feature, pMessage, Timeout);
}

/*********************************************************************************************************************
** Function name:           can0_recv
** Descriptions:            接收报文
** Input parameters:        pMessage : 消息报文
**                          Timeout  : 超时时间(单位: 毫秒)
** Output parameters:       
** Returned value:          ==OS_OK : 操作成功
**                          !=OS_OK : 操作失败(包含出错信息)
**--------------------------------------------------------------------------------------------------------------------
** Created by:              Feng Liang
** Created Date:            2011-12-13  17:19:4
** Test recorde:            
**--------------------------------------------------------------------------------------------------------------------
** Modified by:
** Modified date:
** Test recorde: 
*********************************************************************************************************************/
static int can0_recv(CAN_MESSAGE * pMessage, int Timeout)
{
    return can_recv(&can0_feature, pMessage, Timeout);
}

/*********************************************************************************************************************
** Function name:           can0_cleanup
** Descriptions:            卸载can0设备
** Input parameters:        
** Output parameters:       
** Returned value:          ==OS_OK : 操作成功
**                          !=OS_OK : 操作失败(包含出错信息)
**--------------------------------------------------------------------------------------------------------------------
** Created by:              Feng Liang
** Created Date:            2011-12-13  17:15:12
** Test recorde:            
**--------------------------------------------------------------------------------------------------------------------
** Modified by:
** Modified date:
** Test recorde: 
*********************************************************************************************************************/
static int can0_cleanup(void)
{
    can_cleanup(&can0_feature);
    dword_clear_bits(PCONP, 1ul << 13);                                       /* 禁能can0外设备供电                   */ 

    return OK;
}

/*********************************************************************************************************************
                                                    设备定义区
*********************************************************************************************************************/
const CLASS_CAN        can0 =                                               /* 设备: can0                           */
{
    can0_setup,
    can0_cleanup,
    can0_send,
    can0_recv
};
EXPORT_TO_DEVICE(can0, "CAN总线0");

/*********************************************************************************************************************
                                                    END OF FILE
*********************************************************************************************************************/

