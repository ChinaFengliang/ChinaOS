/******************************************************Copyright (c)**************************************************
**                                              胆怯是阻止一切可能的根本缘由
**
**                                             E-Mail: ChinaFengliang@163.com
**
**---------File Information-------------------------------------------------------------------------------------------
** File name:            can1.c
** Last version:         V1.00
** Descriptions:         can1驱动文件.
** Hardware platform:    lpc1768
** SoftWare platform:    ChinaOS
**
**--------------------------------------------------------------------------------------------------------------------
** Created by:           Feng Liang
** Created date:         2011年12月13日  17:10:22
** Version:              V1.00
** Descriptions:         The original version
**
**--------------------------------------------------------------------------------------------------------------------
** Modified by: 
** Modified date:
** Version:
** Descriptions:
**
*********************************************************************************************************************/

/*********************************************************************************************************************
                                                    头文件区
*********************************************************************************************************************/
#include    <include/macro.h>
#include    <include/types.h>
#include    <library/ioport.h>
#include    <nvic/interrupt.h>
#include    "../../lpc17xx.h"
#include    "./can.h"

/*********************************************************************************************************************
                                                    宏定义区
*********************************************************************************************************************/
/* 宏段名 ----------------------------------------------------------------------------------------------------------*/


/*********************************************************************************************************************
                                                    类型定义区
*********************************************************************************************************************/
/* 基本类型 --------------------------------------------------------------------------------------------------------*/


/*********************************************************************************************************************
                                                  全局变量定义区
*********************************************************************************************************************/
CAN_FEATURE can1_feature =                                                  /* can1设备特性                         */
{
    0x40048000,                                                             /* 寄存器基址                           */
    14,
    CAN_IRQn,
    NULL,

    NULL,
    NULL,

    1,
    5,
    2,
};

/*********************************************************************************************************************
** Function name:           can1_setup
** Descriptions:            安装can1设备
** Input parameters:        Baudrate
** Output parameters:       
** Returned value:          ==OS_OK : 操作成功
**                          !=OS_OK : 操作失败(包含出错信息)
**--------------------------------------------------------------------------------------------------------------------
** Created by:              Feng Liang
** Created Date:            2011-12-13  17:13:54
** Test recorde:            
**--------------------------------------------------------------------------------------------------------------------
** Modified by:
** Modified date:
** Test recorde: 
*********************************************************************************************************************/
static int can1_setup(void)
{
    /* 1)
     * 私有构建过程
     */
    dword_set_bits(PCONP, 1ul << 14);                                       /* 使能can1外设备供电                   */ 
    
#if 1    
    /* 
     * CAN控制器收发引脚配置
     * 引脚p0.4: RD2; 
     * 引脚p0.5: TD2
     */
    dword_modify(PINSEL0, (1ul<<10) | (1ul<<8),                             /* 设置P0.4功能: RD2                    */
                          (1ul<<11) | (1ul<<9));                            /* 设置P0.5功能: TD2                    */
#else   
    /* 
     * CAN控制器收发引脚配置
     * 引脚p2.7: RD2; 
     * 引脚p2.8: TD2
     */
    dword_modify(PINSEL4, (1ul<<17) | (1ul<<15),                            /* 设置P2.7功能: RD2                    */
                          (1ul<<16) | (1ul<<14));                           /* 设置P2.8功能: TD2                    */                           
#endif 

    /* 2)
     * 类构建过程
     */
    can_setup(&can1_feature);
    return OK;
}

/*********************************************************************************************************************
** Function name:           can1_send
** Descriptions:            发送数据
** Input parameters:        
** Output parameters:       
** Returned value:          ==OS_OK : 操作成功
**                          !=OS_OK : 操作失败(包含出错信息)
**--------------------------------------------------------------------------------------------------------------------
** Created by:              Feng Liang
** Created Date:            2011-12-13  17:18:29
** Test recorde:            
**--------------------------------------------------------------------------------------------------------------------
** Modified by:
** Modified date:
** Test recorde: 
*********************************************************************************************************************/
static int can1_send(CAN_MESSAGE *pMessage, int Timeout)
{
    return can_send(&can1_feature, pMessage, Timeout);
}

/*********************************************************************************************************************
** Function name:           can1_recv
** Descriptions:            接收数据
** Input parameters:        
** Output parameters:       
** Returned value:          ==OS_OK : 操作成功
**                          !=OS_OK : 操作失败(包含出错信息)
**--------------------------------------------------------------------------------------------------------------------
** Created by:              Feng Liang
** Created Date:            2011-12-13  17:19:4
** Test recorde:            
**--------------------------------------------------------------------------------------------------------------------
** Modified by:
** Modified date:
** Test recorde: 
*********************************************************************************************************************/
static int can1_recv(CAN_MESSAGE *pMessage, int Timeout)
{
    return can_recv(&can1_feature, pMessage, Timeout);
}

/*********************************************************************************************************************
** Function name:           can1_cleanup
** Descriptions:            卸载can1设备
** Input parameters:        
** Output parameters:       
** Returned value:          ==OS_OK : 操作成功
**                          !=OS_OK : 操作失败(包含出错信息)
**--------------------------------------------------------------------------------------------------------------------
** Created by:              Feng Liang
** Created Date:            2011-12-13  17:15:12
** Test recorde:            
**--------------------------------------------------------------------------------------------------------------------
** Modified by:
** Modified date:
** Test recorde: 
*********************************************************************************************************************/
static int can1_cleanup(void)
{
    can_cleanup(&can1_feature);
    dword_clear_bits(PCONP, 1ul << 14);                                       /* 禁能can1外设备供电                   */ 

    return OK;
}

/*********************************************************************************************************************
                                                    设备定义区
*********************************************************************************************************************/
const CLASS_CAN          can1 =                                               /* 设备: can1                           */
{
    can1_setup,
    can1_cleanup,
    can1_send,
    can1_recv
};
EXPORT_TO_DEVICE(can1, "CAN总线1");

/*********************************************************************************************************************
                                                    END OF FILE
*********************************************************************************************************************/

