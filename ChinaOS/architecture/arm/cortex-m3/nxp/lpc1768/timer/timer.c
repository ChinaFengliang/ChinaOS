/******************************************************Copyright (c)**************************************************
**                                              胆怯是阻止一切可能的根本缘由
**
**                                             E-Mail: ChinaFengliang@163.com
**
**---------File Information-------------------------------------------------------------------------------------------
** File name:            timer.c
** Last version:         V1.00
** Descriptions:         定时器管理机制文件.
** Hardware platform:    
** SoftWare platform:    ChinaOS
**
**--------------------------------------------------------------------------------------------------------------------
** Created by:           Feng Liang
** Created date:         2012年2月9日  23:54:16
** Version:              V1.00
** Descriptions:         The original version
**
**--------------------------------------------------------------------------------------------------------------------
** Modified by: 
** Modified date:
** Version:
** Descriptions:
**
*********************************************************************************************************************/

/*********************************************************************************************************************
                                                    头文件区
*********************************************************************************************************************/
#include    <include/macro.h>
#include    <include/types.h>
#include    <library/ioport.h>
#include    "./timer.h"

/*********************************************************************************************************************
                                                    宏定义区
*********************************************************************************************************************/
/* 寄存器偏移地址 --------------------------------------------------------------------------------------------------*/
#define   IR                0x00
#define   TCR               0x04
#define   TC                0x08
#define   PR                0x0C
#define   PC                0x10
#define   MCR               0x14
#define   MR0               0x18
#define   MR1               0x1C
#define   MR2               0x20
#define   MR3               0x24
#define   CCR               0x28
#define   CR0               0x2C
#define   CR1               0x30
#define   EMR               0x3C
#define   CTCR              0x70

/*********************************************************************************************************************
                                                    类型定义区
*********************************************************************************************************************/
/* 基本类型 --------------------------------------------------------------------------------------------------------*/


/*********************************************************************************************************************
                                                  全局变量定义区
*********************************************************************************************************************/


/*********************************************************************************************************************
** Function name:           timer_setup
** Descriptions:            
** Input parameters:        
** Output parameters:       
** Returned value:          ==OS_OK : 操作成功
**                          !=OS_OK : 操作失败(包含出错信息)
**--------------------------------------------------------------------------------------------------------------------
** Created by:              Feng Liang
** Created Date:            2012-2-10  18:36:11
** Test recorde:            
**--------------------------------------------------------------------------------------------------------------------
** Modified by:
** Modified date:
** Test recorde: 
*********************************************************************************************************************/
int timer_setup(const TIMER_FEATURE *This)
{
    INT32U          BaseAddress;                                            /* 寄存器基址                           */
    INT32U          Prescale;
    
    BaseAddress = This->BaseAddress;
    Prescale    = This->Prescale;
    
    write_dword(BaseAddress + TCR,  0x00);                                  /* 暂停定时器计数                       */
    write_dword(BaseAddress + IR,   0xFF);                                  /* 清除定时器1所有中断标志              */
    write_dword(BaseAddress + PR,   Prescale);                              /* 分频系数: 12499+1=12500分频          */
    write_dword(BaseAddress + CTCR, 0x00);                                  /* 模式选择: 定时器模式                 */
    write_dword(BaseAddress + TCR,  0x01 << 1);                             /* 复位定时器                           */
    //write_dword(BaseAddress + MCR,  0x07);                                  /* 定时器匹配时(中断&复位&停止)         */
    write_dword(BaseAddress + TCR,  0x01);                                  /* 启动定时器T1                         */

    return OK;
}

/*********************************************************************************************************************
** Function name:           timer_cleanup
** Descriptions:            
** Input parameters:        
** Output parameters:       
** Returned value:          ==OS_OK : 操作成功
**                          !=OS_OK : 操作失败(包含出错信息)
**--------------------------------------------------------------------------------------------------------------------
** Created by:              Feng Liang
** Created Date:            2012-2-10  18:43:57
** Test recorde:            
**--------------------------------------------------------------------------------------------------------------------
** Modified by:
** Modified date:
** Test recorde: 
*********************************************************************************************************************/
int timer_cleanup(const TIMER_FEATURE *This)
{
    return OK;
}

/*********************************************************************************************************************
** Function name:           timer_count
** Descriptions:            
** Input parameters:        
** Output parameters:       
** Returned value:          ==OS_OK : 操作成功
**                          !=OS_OK : 操作失败(包含出错信息)
**--------------------------------------------------------------------------------------------------------------------
** Created by:              Feng Liang
** Created Date:            2012-2-11  0:14:22
** Test recorde:            
**--------------------------------------------------------------------------------------------------------------------
** Modified by:
** Modified date:
** Test recorde: 
*********************************************************************************************************************/
INT32U timer_count(const TIMER_FEATURE *This)
{
    INT32U          BaseAddress;                                            /* 寄存器基址                           */


    BaseAddress = This->BaseAddress;
    return read_dword(BaseAddress + TC);
}

/*********************************************************************************************************************
                                                    END OF FILE
*********************************************************************************************************************/

